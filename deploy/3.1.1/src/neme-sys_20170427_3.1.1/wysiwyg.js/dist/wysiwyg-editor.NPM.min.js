!function(e){"use strict";if("function"==typeof define&&define.amd)define(["jquery"],function(t){return e(window,document,navigator,t)});else{if("undefined"==typeof exports)return e(window,document,navigator,jQuery);module.exports=e(window,document,navigator,require("jquery"))}}(function(e,t,n,r,o){"use strict";var i=function(e,t,n){var r;return function(){if(r){if(!n)return;clearTimeout(r)}var o=this,i=arguments;r=setTimeout(function(){r=null,e.apply(o,i)},t)}},a=function(t,n,r,o){t.addEventListener?t.addEventListener(n,r,o?!0:!1):t.attachEvent?t.attachEvent("on"+n,r):t!=e&&(t["on"+n]=r)},l=function(t,n,r,o){t.removeEventListener?t.removeEventListener(n,r,o?!0:!1):t.detachEvent?t.detachEvent("on"+n,r):t!=e&&(t["on"+n]=null)},s=function(e,n,r,i){if(t.createEvent){var a=t.createEvent("Event");a.initEvent(n,r!==o?r:!0,i!==o?i:!1),e.dispatchEvent(a)}else if(t.createEventObject){var a=t.createEventObject();e.fireEvent("on"+n,a)}else"function"==typeof e["on"+n]&&e["on"+n]()},u=function(e){return e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,!1},c="undefined"!=typeof Node?Node.ELEMENT_NODE:1,f="undefined"!=typeof Node?Node.TEXT_NODE:3,p=function(e,t){for(var n=t;n;){if(n===e)return!0;n=n.parentNode}return!1},d=function(e,t){if(e.firstChild)return e.firstChild;for(;e;){if(e==t)return null;if(e.nextSibling)return e.nextSibling;e=e.parentNode}return null},g=function(n){if(e.getSelection){var r=e.getSelection();if(r.rangeCount>0)return r.getRangeAt(0)}else if(t.selection){var r=t.selection;return r.createRange()}return null},h=function(n,r){if(r)if(e.getSelection){var o=e.getSelection();o.removeAllRanges(),o.addRange(r)}else t.selection&&r.select()},v=function(){if(e.getSelection){var n=e.getSelection();if(!n.rangeCount)return!1;var r=n.getRangeAt(0).cloneRange();if(r.getBoundingClientRect){var o=r.getBoundingClientRect();if(o&&o.left&&o.top&&o.right&&o.bottom)return{left:parseInt(o.left),top:parseInt(o.top),width:parseInt(o.right-o.left),height:parseInt(o.bottom-o.top)};for(var i=r.getClientRects?r.getClientRects():[],a=0;a<i.length;++a){var o=i[a];if(o.left&&o.top&&o.right&&o.bottom)return{left:parseInt(o.left),top:parseInt(o.top),width:parseInt(o.right-o.left),height:parseInt(o.bottom-o.top)}}}}else if(t.selection){var n=t.selection;if("Control"!=n.type){var r=n.createRange();if(r.boundingLeft||r.boundingTop||r.boundingWidth||r.boundingHeight)return{left:r.boundingLeft,top:r.boundingTop,width:r.boundingWidth,height:r.boundingHeight}}}return!1},y=function(n){if(e.getSelection){var r=e.getSelection();return r.isCollapsed?!0:!1}if(t.selection){var r=t.selection;if("Text"==r.type){var o=t.selection.createRange(),i=t.body.createTextRange();return i.moveToElementText(n),i.setEndPoint("EndToStart",o),0==o.htmlText.length}if("Control"==r.type)return!1}return!0},m=function(n){if(e.getSelection){var r=e.getSelection();if(!r.rangeCount)return[];for(var o=[],i=0;i<r.rangeCount;++i)for(var a=r.getRangeAt(i),l=a.startContainer,s=a.endContainer;l;){if(l!=n){var u=!1;if(r.containsNode)u=r.containsNode(l,!0);else{var f=t.createRange();f.selectNodeContents(l);for(var i=0;i<r.rangeCount;++i){var a=r.getRangeAt(i);if(a.compareBoundaryPoints(a.END_TO_START,f)>=0&&a.compareBoundaryPoints(a.START_TO_END,f)<=0){u=!0;break}}}u&&o.push(l)}l=d(l,l==s?s:n)}return 0==o.length&&p(n,r.focusNode)&&r.focusNode!=n&&o.push(r.focusNode),o}if(t.selection){var r=t.selection;if("Text"==r.type){for(var o=[],g=r.createRangeCollection(),i=0;i<g.length;++i)for(var a=g[i],h=a.parentElement(),l=h;l;){var f=a.duplicate();if(f.moveToElementText(l.nodeType!=c?l.parentNode:l),f.compareEndPoints("EndToStart",a)>=0&&f.compareEndPoints("StartToEnd",a)<=0){for(var v=!1,y=0;y<o.length;++y)if(o[y]===l){v=!0;break}v||o.push(l)}l=d(l,h)}return 0==o.length&&p(n,t.activeElement)&&t.activeElement!=n&&o.push(t.activeElement),o}if("Control"==r.type){for(var o=[],a=r.createRange(),i=0;i<a.length;++i)o.push(a(i));return o}}return[]},w=function(){if(e.getSelection){var n=e.getSelection();if(!n.isCollapsed)try{n.collapseToEnd()}catch(r){}}else if(t.selection){var n=t.selection;if("Control"!=n.type){var o=n.createRange();o.collapse(!1),o.select()}}},b=function(n,r,o){if(e.getSelection){var i=e.getSelection();if(i.modify){for(var a=0;r>a;++a)i.modify("extend","backward","character");for(var a=0;o>a;++a)i.modify("extend","forward","character")}else{var l=i.getRangeAt(0);l.setStart(l.startContainer,l.startOffset-r),l.setEnd(l.endContainer,l.endOffset+o),i.removeAllRanges(),i.addRange(l)}}else if(t.selection){var i=t.selection;if("Control"!=i.type){var l=i.createRange();l.collapse(!0),l.moveStart("character",-r),l.moveEnd("character",o),l.select()}}},C=function(n){if(y(n))return null;if(e.getSelection){var r=e.getSelection();if(r.rangeCount){for(var o=t.createElement("div"),i=r.rangeCount,a=0;i>a;++a){var l=r.getRangeAt(a).cloneContents();o.appendChild(l)}return o.innerHTML}}else if(t.selection){var r=t.selection;if("Text"==r.type){var s=r.createRange();return s.htmlText}}return null},T=function(n,r){if(e.getSelection){var o=e.getSelection();if(p(n,o.anchorNode)&&p(n,o.focusNode))return!0;if(!r)return!1;var i=t.createRange();i.selectNodeContents(n),i.collapse(!1),o.removeAllRanges(),o.addRange(i)}else if(t.selection){var o=t.selection;if("Control"==o.type){var i=o.createRange();if(0!=i.length&&p(n,i(0)))return!0}else{var a=t.body.createTextRange();a.moveToElementText(n);var i=o.createRange();if(a.inRange(i))return!0}if(!r)return!1;var i=t.body.createTextRange();i.moveToElementText(n),i.setEndPoint("StartToEnd",i),i.select()}return!0},E=function(n,r){if(e.getSelection){var o=e.getSelection();if(o.getRangeAt&&o.rangeCount){var i=o.getRangeAt(0),a=t.createElement("div");a.innerHTML=r;for(var l,s,u=t.createDocumentFragment();l=a.firstChild;)s=u.appendChild(l);p(n,i.commonAncestorContainer)?(i.deleteContents(),i.insertNode(u)):n.appendChild(u),s&&(i=i.cloneRange(),i.setStartAfter(s),i.collapse(!0),o.removeAllRanges(),o.addRange(i))}}else if(t.selection){var o=t.selection;if("Control"!=o.type){var c=o.createRange();c.collapse(!0);var i=o.createRange();if(p(n,i.parentElement()))i.pasteHTML(r);else{var f=t.body.createTextRange();f.moveToElementText(n),f.collapse(!1),f.select(),f.pasteHTML(r)}i=o.createRange(),i.setEndPoint("StartToEnd",c),i.select()}}},S=function(r){r=r||{};var o=r.element||null;"string"==typeof o&&(o=t.getElementById(o));var S=r.onKeyDown||null,L=r.onKeyPress||null,R=r.onKeyUp||null,x=r.onSelection||null,k=r.onPlaceholder||null,P=r.onClosepopup||null,I=r.hijackContextmenu||!1,M="TEXTAREA"==o.nodeName||"INPUT"==o.nodeName;if(M){var N="contentEditable"in t.body;if(N){var H=n.userAgent.match(/(?:iPad|iPhone|Android).* AppleWebKit\/([^ ]+)/);H&&420<=parseInt(H[1])&&parseInt(H[1])<534&&(N=!1)}if(!N){var A=o,D=function(e){return e.replace(/<br[ \/]*>\n?/gi,"<br>\n")};A.value=D(A.value);var O=function(){return this},j=function(){return null};return{legacy:!0,getElement:function(){return A},getHTML:function(){return A.value},setHTML:function(e){return A.value=D(e),this},getSelectedHTML:j,sync:O,collapseSelection:O,expandSelection:O,openPopup:j,closePopup:O,removeFormat:O,bold:O,italic:O,underline:O,strikethrough:O,forecolor:O,highlight:O,fontName:O,fontSize:O,subscript:O,superscript:O,align:O,format:O,indent:O,insertLink:O,insertImage:O,insertHTML:O,insertList:O}}}var A=null,K=null;if(M){A=o,A.style.display="none",K=t.createElement("DIV"),K.innerHTML=A.value;var B=A.parentNode,F=A.nextSibling;F?B.insertBefore(K,F):B.appendChild(K)}else K=o;K.setAttribute("contentEditable","true");var W=t.all&&!t.addEventListener?t:e,U=null;if(M){var X=K.innerHTML;U=function(){var e=K.innerHTML;e!=X&&(A.value=e,X=e,s(A,"change",!1))}}var q;if(k){var Y=!1;q=function(){for(var e=!0,t=K;t;)if(t=d(t,K)){if(t.nodeType==c){if("IMG"==t.nodeName){e=!1;break}}else if(t.nodeType==f){var n=t.nodeValue;if(n&&-1!=n.search(/[^\s]/)){e=!1;break}}}else;Y!=e&&(k(e),Y=e)},q()}var _=null,V=null,z=null;x&&(V=function(t,n,r){var o=y(K),i=m(K),a=null===t||null===n?null:{left:t,top:n,width:0,height:0},l=v();if(l&&(a=l),a){if(K.getBoundingClientRect){var s=K.getBoundingClientRect();a.left-=parseInt(s.left),a.top-=parseInt(s.top)}else{var u=K,f=0,p=0,d=!1;do f+=u.offsetLeft?parseInt(u.offsetLeft):0,p+=u.offsetTop?parseInt(u.offsetTop):0,"fixed"==u.style.position&&(d=!0);while(u=u.offsetParent);a.left-=f-(d?0:e.pageXOffset),a.top-=p-(d?0:e.pageYOffset)}a.left<0&&(a.left=0),a.top<0&&(a.top=0),a.width>K.offsetWidth&&(a.width=K.offsetWidth),a.height>K.offsetHeight&&(a.height=K.offsetHeight)}else if(i.length)for(var g=0;g<i.length;++g){var u=i[g];if(u.nodeType==c){a={left:u.offsetLeft,top:u.offsetTop,width:u.offsetWidth,height:u.offsetHeight};break}}x(o,a,i,r)},z=i(V,1));var $=null,G=function(t){if(!t)var t=e.event;var n=t.target||t.srcElement;n.nodeType==f&&(n=n.parentNode),p($,n)||J()},Q=function(){if($)return $;a(W,"mousedown",G,!0),$=t.createElement("DIV");var e=K.parentNode,n=K.nextSibling;return n?e.insertBefore($,n):e.appendChild($),$},J=function(){$&&($.parentNode.removeChild($),$=null,l(W,"mousedown",G,!0),P&&P())};a(K,"focus",function(){A&&s(A,"focus",!1)}),a(K,"blur",function(){U&&U(),A&&s(A,"blur",!1)});var Z=null;if(q||U){var ee=U?i(U,250,!0):null,te=function(e){q&&q(),ee&&ee()};Z=i(te,1),a(K,"input",Z),a(K,"DOMNodeInserted",Z),a(K,"DOMNodeRemoved",Z),a(K,"DOMSubtreeModified",Z),a(K,"DOMCharacterDataModified",Z),a(K,"propertychange",Z),a(K,"textInput",Z),a(K,"paste",Z),a(K,"cut",Z),a(K,"drop",Z)}var ne=function(t,n){if(!t)var t=e.event;var r=t.which||t.keyCode,o=String.fromCharCode(r||t.charCode),i=t.shiftKey||!1,a=t.altKey||!1,l=t.ctrlKey||!1,s=t.metaKey||!1;if(1==n){if(S&&S(r,o,i,a,l,s)===!1)return u(t)}else if(2==n){if(L&&L(r,o,i,a,l,s)===!1)return u(t)}else if(3==n&&R&&R(r,o,i,a,l,s)===!1)return u(t);if((2==n||3==n)&&(_=null,z&&z(null,null,!1)),2==n&&Z)switch(r){case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:break;default:Z()}};a(K,"keydown",function(e){return ne(e,1)}),a(K,"keypress",function(e){return ne(e,2)}),a(K,"keyup",function(e){return ne(e,3)});var re=function(t,n){if(!t)var t=e.event;var r=null,o=null;t.clientX&&t.clientY?(r=t.clientX,o=t.clientY):t.pageX&&t.pageY&&(r=t.pageX-e.pageXOffset,o=t.pageY-e.pageYOffset),t.which&&3==t.which?n=!0:t.button&&2==t.button&&(n=!0),l(W,"mouseup",re),_=null,(I||!n)&&z&&z(r,o,n)};a(K,"mousedown",function(e){l(W,"mouseup",re),a(W,"mouseup",re)}),a(K,"mouseup",function(e){re(e),Z&&Z()}),a(K,"dblclick",function(e){re(e)}),a(K,"selectionchange",function(e){re(e)}),I&&a(K,"contextmenu",function(e){return re(e,!0),u(e)});var oe=function(n,r,o){if(h(K,_),!T(K,o))return!1;if(e.getSelection)try{return t.queryCommandSupported&&!t.queryCommandSupported(n)?!1:t.execCommand(n,!1,r)}catch(i){}else if(t.selection){var a=t.selection;if("None"!=a.type){var l=a.createRange();try{return l.queryCommandEnabled(n)?l.execCommand(n,!1,r):!1}catch(i){}}}return!1},ie=null,ae=function(){(t.all||e.MSInputMethodContext)&&(ie=t.createElement("DIV"),K.appendChild(ie))},le=function(e){ie&&(K.removeChild(ie),ie=null),Z&&Z(),e?(w(),_=null):_&&(_=g(K))};return{getElement:function(){return K},getHTML:function(){return K.innerHTML},setHTML:function(e){return K.innerHTML=e,le(!0),this},getSelectedHTML:function(){return h(K,_),T(K)?C(K):null},sync:function(){return U&&U(),this},collapseSelection:function(){return w(),_=null,this},expandSelection:function(e,t){return h(K,_),T(K)?(b(K,e,t),_=g(K),this):this},openPopup:function(){return _||(_=g(K)),Q()},closePopup:function(){return J(),this},removeFormat:function(){return oe("removeFormat"),oe("unlink"),le(),this},bold:function(){return oe("bold"),le(),this},italic:function(){return oe("italic"),le(),this},underline:function(){return oe("underline"),le(),this},strikethrough:function(){return oe("strikeThrough"),le(),this},forecolor:function(e){return oe("foreColor",e),le(),this},highlight:function(e){return oe("hiliteColor",e)||oe("backColor",e),le(),this},fontName:function(e){return oe("fontName",e),le(),this},fontSize:function(e){return oe("fontSize",e),le(),this},subscript:function(){return oe("subscript"),le(),this},superscript:function(){return oe("superscript"),le(),this},align:function(e){return ae(),"left"==e?oe("justifyLeft"):"center"==e?oe("justifyCenter"):"right"==e?oe("justifyRight"):"justify"==e&&oe("justifyFull"),le(),this},format:function(e){return ae(),oe("formatBlock",e),le(),this},indent:function(e){return ae(),oe(e?"outdent":"indent"),le(),this},insertLink:function(e){return oe("createLink",e),le(!0),this},insertImage:function(e){return oe("insertImage",e,!0),le(!0),this},insertHTML:function(e){return oe("insertHTML",e,!0)||(h(K,_),T(K,!0),E(K,e)),le(!0),this},insertList:function(e){return ae(),oe(e?"insertOrderedList":"insertUnorderedList"),le(),this}}},L=function(e,t,n){var r,o,i,a,l,s,u,c;switch(a=Math.floor(6*e),l=6*e-a,s=n*(1-t),u=n*(1-l*t),c=n*(1-(1-l)*t),a%6){case 0:r=n,o=c,i=s;break;case 1:r=u,o=n,i=s;break;case 2:r=s,o=n,i=c;break;case 3:r=s,o=u,i=n;break;case 4:r=c,o=s,i=n;break;case 5:r=n,o=s,i=u}var f=Math.floor(255*r).toString(16),p=Math.floor(255*o).toString(16),d=Math.floor(255*i).toString(16);return"#"+(f.length<2?"0":"")+f+(p.length<2?"0":"")+p+(d.length<2?"0":"")+d},R=function(e){return e.replace(/[&<>"]/g,function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};return t[e]||e})},x=function(n,o,i,a,l,s,u,c,f,p,d,g,h,v,y,m,w){var b=function(e,t){t&&(e.getSelectedHTML()?e.insertLink(t):e.insertHTML('<a href="'+R(t)+'">'+R(t)+"</a>")),e.closePopup().collapseSelection()},C=function(e,t){var n=P(s),o=r('<input type="text" value="'+(t?t.attr("href"):"")+'" />').addClass("wysiwyg-input").keypress(function(n){(10==n.which||13==n.which)&&(t?(t.attr("href",o.val()),e.closePopup().collapseSelection()):b(e,o.val()))});c&&o.attr("placeholder",c);var i=n.click(function(n){return t?(t.attr("href",o.val()),e.closePopup().collapseSelection()):b(e,o.val()),n.stopPropagation(),n.preventDefault(),!1}),a=r("<div/>").addClass("wysiwyg-toolbar-form").attr("unselectable","on");return a.append(o).append(i),a},T=function(t){var n=function(e,n){var o='<img id="wysiwyg-insert-image" src="" alt=""'+(n?' title="'+R(n)+'"':"")+" />";t.insertHTML(o).closePopup().collapseSelection();var i=r("#wysiwyg-insert-image").removeAttr("id");p&&i.css({maxWidth:p[0]+"px",maxHeight:p[1]+"px"}).load(function(){i.css({maxWidth:"",maxHeight:""});var e=i.width(),t=i.height();(e>p[0]||t>p[1])&&(e/t>p[0]/p[1]?(t=parseInt(t/e*p[0]),e=p[0]):(e=parseInt(e/t*p[1]),t=p[1]),i.attr("width",e).attr("height",t))}),i.attr("src",e)},o=r("<div/>").addClass("wysiwyg-toolbar-form").attr("unselectable","on"),i=null,a=r('<input type="file" />').css({position:"absolute",left:0,top:0,width:"100%",height:"100%",opacity:0,cursor:"pointer"});if(!g&&e.File&&e.FileReader&&e.FileList){var l=function(e){if(e.type.match("image.*")){var t=new FileReader;t.onload=function(t){var r=t.target.result;n(r,e.name)},t.readAsDataURL(e)}};i=a.attr("draggable","true").change(function(e){for(var t=e.target.files,n=0;n<t.length;++n)l(t[n])}).on("dragover",function(e){return e.originalEvent.dataTransfer.dropEffect="copy",e.stopPropagation(),e.preventDefault(),!1}).on("drop",function(e){for(var t=e.originalEvent.dataTransfer.files,n=0;n<t.length;++n)l(t[n]);return e.stopPropagation(),e.preventDefault(),!1})}else if(d){var f=a.change(function(e){d.call(this,n)});i=r("<form/>").append(f)}i&&r("<div/>").addClass("wysiwyg-browse").html(u).append(i).appendTo(o);var h=P(s),v=r('<input type="text" value="" />').addClass("wysiwyg-input").keypress(function(e){(10==e.which||13==e.which)&&n(v.val())});c&&v.attr("placeholder",c);var y=h.click(function(e){return n(v.val()),e.stopPropagation(),e.preventDefault(),!1});return o.append(r("<div/>").append(v).append(y)),o},E=function(e){var t=function(t,n){t=r.trim(t||""),n=r.trim(n||"");var o=!1;t.length&&!n.length?o=t:-1==n.indexOf("<")&&-1==n.indexOf(">")&&n.match(/^(?:https?:\/)?\/?(?:[^:\/\s]+)(?:(?:\/\w+)*\/)(?:[\w\-\.]+[^#?\s]+)(?:.*)?(?:#[\w\-]+)?$/)&&(o=n),o&&h&&(n=h(o)||""),!n.length&&o&&(n='<video src="'+R(o)+'" />'),e.insertHTML(n).closePopup().collapseSelection()},n=r("<div/>").addClass("wysiwyg-toolbar-form").attr("unselectable","on"),o=r("<textarea>").addClass("wysiwyg-input wysiwyg-inputtextarea");f&&o.attr("placeholder",f),r("<div/>").addClass("wysiwyg-embedcode").append(o).appendTo(n);var i=P(s),a=r('<input type="text" value="" />').addClass("wysiwyg-input").keypress(function(e){(10==e.which||13==e.which)&&t(a.val())});c&&a.attr("placeholder",c);var l=i.click(function(e){return t(a.val(),o.val()),e.stopPropagation(),e.preventDefault(),!1});return n.append(r("<div/>").append(a).append(l)),n},x=function(e,t){for(var n=r("<table/>").attr("cellpadding","0").attr("cellspacing","0").attr("unselectable","on"),o=1;15>o;++o){for(var i=r("<tr/>"),a=0;25>a;++a){var l;if(24==a){var s=Math.floor(255/13*(14-o)).toString(16),u=(s.length<2?"0":"")+s;l="#"+u+u+u}else{var c=a/24,f=8>=o?o/8:1,p=o>8?(16-o)/8:1;l=L(c,f,p)}r("<td/>").addClass("wysiwyg-toolbar-color").attr("title",l).attr("unselectable","on").css({backgroundColor:l}).click(function(){var n=this.title;return t?e.forecolor(n).closePopup().collapseSelection():e.highlight(n).closePopup().collapseSelection(),!1}).appendTo(i)}n.append(i)}return n},k=function(e,t){switch(e){case"insertimage":return t?function(e){t(T(j),e)}:null;case"insertvideo":return t?function(e){t(E(j),e)}:null;case"insertlink":return t?function(e){t(C(j),e)}:null;case"bold":return function(){j.bold()};case"italic":return function(){j.italic()};case"underline":return function(){j.underline()};case"strikethrough":return function(){j.strikethrough()};case"forecolor":return t?function(e){t(x(j,!0),e)}:null;case"highlight":return t?function(e){t(x(j,!1),e)}:null;case"alignleft":return function(){j.align("left")};case"aligncenter":return function(){j.align("center")};case"alignright":return function(){j.align("right")};case"alignjustify":return function(){j.align("justify")};case"subscript":return function(){j.subscript()};case"superscript":return function(){j.superscript()};case"indent":return function(){j.indent()};case"outdent":return function(){j.indent(!0)};case"orderedList":return function(){j.insertList(!0)};case"unorderedList":return function(){j.insertList()};case"removeformat":return function(){j.removeFormat().closePopup().collapseSelection()}}return null},P=function(e){return r("<a/>").addClass("wysiwyg-toolbar-icon").attr("href","#").attr("title",e.title).attr("unselectable","on").append(e.image)},I=function(e,t,n,o){r.each(l,function(i,a){if(a&&!(t===!1&&"showstatic"in a&&!a.showstatic||t===!0&&"showselection"in a&&!a.showselection)){var l;l="click"in a?function(e){a.click(r(e))}:"popup"in a?function(e){var t=n(),i=a.popup(t,r(e));o(t,e,i)}:k(i,function(e,t){var r=n();r.append(e),o(r,t),r.find("input[type=text]:first").focus()});var s;l?s=P(a).click(function(e){return l(e.currentTarget),k(i)&&j.getElement().focus(),e.stopPropagation(),e.preventDefault(),!1}):a.html&&(s=r(a.html)),s&&e.append(s)}})},M=function(n,o,i,a){for(var l=o.get(0),s=l.offsetParent,u={left:0,top:0},c=!1,f=!1,p=n.width(),d=s;d;){u.left+=d.offsetLeft,u.top+=d.offsetTop;var g=r(d);"fixed"==g.css("position")&&(c=!0),"visible"!=g.css("overflow")&&(f=!0),d=d.offsetParent}var h=r(s||t.body);h.append(n),i+=l.offsetLeft,a+=l.offsetTop,(c||f)&&(i+p>h.width()-1&&(i=h.width()-p-1),1>i&&(i=1));var v=r(e).width();u.left+i+p>v-1&&(i=v-u.left-p-1);var y=c?0:r(e).scrollLeft();u.left+i<y+1&&(i=y-u.left+1),n.css({left:parseInt(i)+"px",top:parseInt(a)+"px"})},N={},H=null,A=function(e,t,n){var o=function(e,t,n,o,i,a,l){if(w){var u=H||"";switch(t){case 8:u=u.substring(0,u.length-1);case 13:case 27:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:if(e)return;n=!1;break;default:if(!e)return;u+=n}var c=w(u,t,n,o,i,a,l);if("object"!=typeof c||!c.length)return s.closePopup(),H=null,c;var f=r(s.openPopup());f.hide().addClass("wysiwyg-popup wysiwyg-popuphover").empty().append(c),H=u}},i={element:e.get(0),onKeyDown:function(e,t,n,r,i,a){if(v&&v(e,t,n,r,i,a)===!1)return!1;if(t&&!n&&!r&&i&&!a){var l=t.toLowerCase();if(!N[l])return;return N[l](),!1}return o(!1,e,t,n,r,i,a)},onKeyPress:function(e,t,n,r,i,a){return y&&y(e,t,n,r,i,a)===!1?!1:o(!0,e,t,n,r,i,a)},onKeyUp:function(e,t,n,r,o,i){return m&&m(e,t,n,r,o,i)===!1?!1:void 0},onSelection:function(e,n,o,i){var l=!0,u=null;if(e&&r.each(o,function(e,t){return 0!=r(t).parents("a").length?(u=C(s,r(t).parents("a:first")),!1):void 0}),n?u||i||H||("selection"!=a&&"top-selection"!=a&&"bottom-selection"!=a?l=!1:e?l=!1:1==o.length&&"IMG"==o[0].nodeName&&(l=!1)):l=!1,!l)return void s.closePopup();var c,f=function(){var e=c.outerWidth(),o=t.offset(),i=r(s.getElement()).offset(),a=n.left+parseInt(n.width/2)-parseInt(e/2)+i.left-o.left,l=n.top+n.height+i.top-o.top;M(c,t,a,l)};c=r(s.openPopup()),c.hasClass("wysiwyg-popuphover")&&!c.data("special")==!u||(c=r(s.closePopup().openPopup())),H?c.show():c.hasClass("wysiwyg-popup")||(c.addClass("wysiwyg-popup wysiwyg-popuphover"),u?c.empty().append(u).data("special",!0):I(c,!0,function(){return c.empty()},f)),f()},onClosepopup:function(){H=null},hijackContextmenu:"selection"==a};if(n){var l=r("<div/>").addClass("wysiwyg-placeholder").html(n).hide();t.prepend(l),i.onPlaceholder=function(e){e?l.show():l.hide()}}var s=S(i);return s},D=r("<div/>").addClass("wysiwyg-container");o&&D.addClass(o),n.wrap(D),D=n.parent(".wysiwyg-container");var O=!1;i&&(O=r("<div/>").addClass("wysiwyg-wrapper").click(function(){j.getElement().focus()}),n.wrap(O),O=n.parent(".wysiwyg-wrapper"));var j=A(n,i?O:D,i);if(j.legacy){var n=r(j.getElement());n.addClass("wysiwyg-textarea"),n.is(":visible")&&n.width(D.width()-(n.outerWidth()-n.width()))}else r(j.getElement()).addClass("wysiwyg-editor");var K={};if(r.each(l,function(e,t){if(t&&t.hotkey){var n=k(e);n&&(N[t.hotkey.toLowerCase()]=n,K[e]=n)}}),"selection"!=a){var B="top"==a||"top-selection"==a,F=r("<div/>").addClass("wysiwyg-toolbar").addClass(B?"wysiwyg-toolbar-top":"wysiwyg-toolbar-bottom");I(F,!1,function(){var e=r(j.openPopup());return e.hasClass("wysiwyg-popup")&&e.hasClass("wysiwyg-popuphover")&&(e=r(j.closePopup().openPopup())),e.hasClass("wysiwyg-popup")||e.addClass("wysiwyg-popup"),e},function(e,t,n){var o=r(t),i=e.outerWidth(),a=o.offset().left-D.offset().left+parseInt(o.width()/2)-parseInt(i/2),l=o.offset().top-D.offset().top;B?l+=o.outerHeight():l-=e.outerHeight(),n&&(a=n.left,l=n.top),M(e,D,a,l)}),B?D.prepend(F):D.append(F)}return{wysiwygeditor:j,$container:D}};r.fn.wysiwyg=function(e,t){if(!e||"object"==typeof e)return e=r.extend({},e),this.each(function(){var t=r(this);if(!t.data("wysiwyg")){var n=e.classes,o=e.placeholder||t.attr("placeholder"),i=!e.toolbar||"top"!=e.toolbar&&"top-selection"!=e.toolbar&&"bottom"!=e.toolbar&&"bottom-selection"!=e.toolbar&&"selection"!=e.toolbar?"top-selection":e.toolbar,a=e.buttons,l=e.submit,s=e.selectImage,u=e.placeholderUrl||null,c=e.placeholderEmbed||null,f=e.maxImageSize||null,p=e.onImageUpload||null,d=e.forceImageUpload&&p,g=e.videoFromUrl||null,h=e.onKeyDown||null,v=e.onKeyPress||null,y=e.onKeyUp||null,m=e.onAutocomplete||null,w=x(t,n,o,i,a,l,s,u,c,f,p,d,g,h,v,y,m);t.data("wysiwyg",w)}});if(1==this.length){var n=this.data("wysiwyg");if(!n)return this;if("container"==e)return n.$container;if("shell"==e)return n.wysiwygeditor}return this}});